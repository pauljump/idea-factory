#!/bin/bash
set -e

# if-sync - Sync methodology templates to all projects
# Usage: if-sync [--dry-run] [--init-missing]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

# Source utilities
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/scaffold.sh"

# Show help
show_help() {
    cat << EOF
if-sync - Sync methodology templates to all projects

Usage:
  if-sync [options]

Options:
  --init-missing Initialize .idea-factory/ in projects that don't have it
  --dry-run      Show what would be synced without making changes
  -h, --help     Show this help message

What gets synced:
  ✓ working-guide.md
  ✓ conversation-protocol.md
  ✓ experiment-template.md
  ✓ github-integration.md

What does NOT get synced:
  ✗ idea-context.json (project-specific)

Example:
  # Edit master template
  open ~/.ideafactory/templates/.idea-factory/working-guide.md

  # Sync to all projects
  if-sync

  # Initialize missing + sync
  if-sync --init-missing

For more help: https://github.com/pauljump/idea-factory
EOF
}

# Parse arguments
DRY_RUN=false
INIT_MISSING=false

for arg in "$@"; do
    case $arg in
        -h|--help)
            show_help
            exit 0
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        --init-missing)
            INIT_MISSING=true
            ;;
    esac
done

# Main sync logic
TEMPLATES_DIR="$(get_templates_dir)/.idea-factory"
CLAUDE_TEMPLATE_DIR="$(get_templates_dir)/.claude"
PROJECTS_DIR="$(get_projects_dir)"

if [ ! -d "$TEMPLATES_DIR" ]; then
    die "Templates directory not found: $TEMPLATES_DIR"
fi

echo ""
log_header "Syncing Idea Factory to all projects"
echo ""

if [ "$DRY_RUN" = true ]; then
    log_warning "DRY RUN - No changes will be made"
    echo ""
fi

log_info "Source: $TEMPLATES_DIR"
log_info "Target: $PROJECTS_DIR/*/"
echo ""

# Find all directories in projects
count=0
synced=0
initialized=0
skipped=0

for project in "$PROJECTS_DIR"/*; do
    if [ ! -d "$project" ]; then
        continue
    fi

    # Skip idea-factory itself
    if [[ "$project" == *"idea-factory"* ]] || [[ "$project" == *"idea_factory"* ]]; then
        continue
    fi

    project_name=$(basename "$project")
    ((count++))

    # Check if has .idea-factory/
    if [ -d "$project/.idea-factory" ]; then
        # Sync templates
        if [ "$DRY_RUN" = true ]; then
            echo_blue "  Would sync: $project_name"
        else
            # Copy templates (preserve idea-context.json)
            for template in "$TEMPLATES_DIR"/*; do
                template_name=$(basename "$template")
                # Skip idea-context.json files
                if [[ "$template_name" == idea-context.json* ]]; then
                    continue
                fi
                cp "$template" "$project/.idea-factory/"
            done
            echo_green "  ✓ $project_name (synced)"
            ((synced++))
        fi
    elif [ "$INIT_MISSING" = true ]; then
        # Initialize .idea-factory/ and .claude/
        if [ "$DRY_RUN" = true ]; then
            echo_blue "  Would initialize: $project_name"
        else
            cd "$project"

            # Initialize .claude/ if missing
            if [ ! -d ".claude" ]; then
                init_claude_structure "$project_name"
            fi

            # Initialize .idea-factory/
            copy_idea_factory_templates
            create_idea_context "$project_name" "" "concept"

            # Create experiments/ if missing
            if [ ! -d "experiments" ]; then
                mkdir -p experiments
            fi

            echo_green "  ✓ $project_name (initialized)"
            ((initialized++))
        fi
    else
        echo_yellow "  ⊘ $project_name (skipped - no .idea-factory/)"
        ((skipped++))
    fi
done

echo ""

if [ "$DRY_RUN" = true ]; then
    log_info "Would sync $synced projects"
    if [ "$INIT_MISSING" = true ]; then
        log_info "Would initialize $initialized projects"
    fi
    echo ""
    log_info "Run without --dry-run to apply changes"
else
    if [ $synced -gt 0 ]; then
        log_success "Synced $synced projects"
    fi
    if [ $initialized -gt 0 ]; then
        log_success "Initialized $initialized projects"
    fi
    if [ $skipped -gt 0 ]; then
        log_info "$skipped projects skipped (use --init-missing to initialize)"
    fi
    if [ $synced -eq 0 ] && [ $initialized -eq 0 ]; then
        log_warning "No projects found"
        echo ""
        log_info "Create a project first: if-setup my-project"
        log_info "Or initialize existing: if-sync --init-missing"
    fi
fi

echo ""
